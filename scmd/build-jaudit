#!/bin/sh
#
# This code is part of the Jaudit utilty.
#
# (C) Copyright IBM 2023.
#
# This code is licensed under the Apache License, Version 2.0. You may
# obtain a copy of this license in the LICENSE.txt file in the root directory
# of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.
#
# Any modifications or derivative works of this code must retain this
# copyright notice, and modified files need to carry a notice indicating
# that they have been altered from the originals.
#

BINDIR=`dirname $0`
DIR=`dirname $BINDIR`

SRCDIR=$DIR/src/
TEMPLATE=$DIR/cf/template.cf
output="./jaudit.py"

while [ $# != 0 ];
do
  arg="$1"
  shift
  case "$arg" in
  -o) output="$1"; shift;;
  -t) template="$1"; shift;;
  esac
done


var_src="$DIR/src"
var_top="`realpath \"$DIR\"/..`"

{
  echo "#!/usr/bin/python"

  cat <<EOH
#
# (C) Copyright IBM 2023.
#
# This code is licensed under the Apache License, Version 2.0. You may
# obtain a copy of this license in the LICENSE.txt file in the root directory
# of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.
#
# Any modifications or derivative works of this code must retain this
# copyright notice, and modified files need to carry a notice indicating
# that they have been altered from the originals.
#
#------------------------------------------------------------------------
EOH

  echo "#"
  echo "# This file is autogenerated; if you are editing this file"
  echo "# you are on the wrong path."
  echo "#"
  D=`date +%Y/%m/%d`
  echo "buildDate=\"$D\""
  (
    cd "$top" && 
    GV="`git rev-parse HEAD 2>/dev/null`"
    [ "x$GV" != 'x' ] && {
      echo "gitRevision=\"$GV\""
    }
  )
  egrep -v '^##' "$SRCDIR"/imports.py < /dev/null

  echo

  awk -F/ '
  BEGIN {
     OFS="/";
  }
  {
     for(i=1;i<=NF;i++){
        if($i == "%top"){
	   $i = "'"$var_top"'";
	}
	else if($i == "%src"){
	   $i = "'"$var_src"'";
	}
     }
     print $0;
  }' $TEMPLATE |
  while read name
  do
    fn="`basename \"$name\"`"
    echo "# $fn "
    egrep -v '^(from|import|##)' "$name"
  done
} > "$output"

chmod 755 "$output"
